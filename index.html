<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hybrid Coach V24 (Native)</title>
    
    <!-- Tailwind CSS (Funktioniert meistens, Fallback CSS ist unten eingebaut) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' };
    </script>

    <style>
        /* Basis CSS falls Tailwind nicht lädt */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; background-color: #f8fafc; color: #1e293b; transition: background 0.3s, color 0.3s; }
        .dark body { background-color: #0f172a; color: #f1f5f9; }
        
        /* Hilfsklassen */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 0.5rem; }
        .p-4 { padding: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .border { border-width: 1px; }
        .w-full { width: 100%; }
        .font-bold { font-weight: 700; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        
        /* Bar Animation */
        .bar-grow { animation: growUp 0.6s ease-out forwards; transform-origin: bottom; transform: scaleY(0); }
        @keyframes growUp { to { transform: scaleY(1); } }

        /* Dark Mode overrides */
        html.dark body { background-color: #020617; color: #f8fafc; }
        html.dark .bg-white { background-color: #1e293b; }
        html.dark .border-slate-100 { border-color: #334155; }
        html.dark input, html.dark select { background-color: #334155; border-color: #475569; color: white; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-300">

    <div id="app" class="max-w-md mx-auto p-4 pb-24 min-h-screen">
        <!-- App wird hier gerendert -->
    </div>

    <!-- MODAL -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeModal()">
        <div id="modal-content" class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl transition-all" onclick="event.stopPropagation()">
            <!-- Modal Body -->
        </div>
    </div>

    <script>
        // --- 1. STATE & STORAGE ---
        const STORE = {
            CONF: 'hybridV24_conf',
            LOGS: 'hybridV24_logs',
            USER: 'hybridV24_user',
            THEME: 'hybridV24_dark'
        };

        // Standard-Daten
        const defaultConfigs = Array(14).fill(null).map(() => ({ uni: ['Montag','Donnerstag'], vol: true, bike: [] }));
        
        let state = {
            week: 0,
            view: 'plan', // 'plan' | 'stats'
            statsView: 'overview',
            configs: JSON.parse(localStorage.getItem(STORE.CONF)) || defaultConfigs,
            logs: JSON.parse(localStorage.getItem(STORE.LOGS)) || {},
            user: JSON.parse(localStorage.getItem(STORE.USER)) || { maxHR: 190 },
            darkMode: JSON.parse(localStorage.getItem(STORE.THEME)) || false
        };

        const weekDays = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];

        // --- 2. ICONS (SVG Strings) ---
        const icons = {
            gym: `<svg class="w-5 h-5 text-blue-600 dark:text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></svg>`,
            run: `<svg class="w-5 h-5 text-orange-500 dark:text-orange-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 11 3.8 11 8c0 2.85-1.67 5.71-2 8a7 7 0 0 0 2 5.18V22H5a2 2 0 0 1-2-2v-4"/><path d="M20 20v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C14.63 6 13 7.8 13 12c0 2.85 1.67 5.71 2 8a7 7 0 0 0-2 5.18V26h6a2 2 0 0 0 2-2v-4"/></svg>`,
            bike: `<svg class="w-5 h-5 text-teal-600 dark:text-teal-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="5.5" cy="17.5" r="3.5"/><circle cx="18.5" cy="17.5" r="3.5"/><path d="M15 6h-5"/><path d="M12 17.5V14l-3-3 4-3 2 3h2"/></svg>`,
            vol: `<svg class="w-5 h-5 text-pink-600 dark:text-pink-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"/><path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"/></svg>`,
            rest: `<svg class="w-5 h-5 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`,
            check: `<svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`,
            left: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>`,
            right: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>`,
            close: `<svg class="w-6 h-6 text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`,
            save: `<svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>`,
            chart: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>`,
            cal: `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`,
            brain: `<svg class="w-4 h-4 text-indigo-600 dark:text-indigo-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>`,
            sun: `<svg class="w-5 h-5 text-amber-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>`,
            moon: `<svg class="w-5 h-5 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>`,
            heart: `<svg class="w-4 h-4 text-red-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" /></svg>`
        };

        // --- 3. LOGIC & SPLITS ---
        const splits = {
            Upper: { t: "Gym: Oberkörper", d: "Brust, Rücken, Schultern, Arme", ex: ["Bankdrück-Maschine", "Ruder-Maschine", "Schulterpresse", "Latzug", "Trizeps Kabel", "Bizeps Maschine"] },
            Lower: { t: "Gym: Beine", d: "Kraft & Stabilität (Maschinen)", ex: ["Beinpresse 45°", "Beinstrecker", "Beinbeuger", "Wadenheben", "Abduktoren", "Adduktoren", "Core"] },
            Push: { t: "Gym: Push", d: "Brust, Schulter, Trizeps", ex: ["Brustpresse", "Schulterpresse", "Seitheben", "Trizepsdrücken"] },
            Pull: { t: "Gym: Pull", d: "Rücken, Bizeps", ex: ["Latzug", "Rudern", "Face Pulls", "Bizeps Curls"] },
            Legs: { t: "Gym: Beine", d: "Unterkörper Fokus", ex: ["Beinpresse", "Ausfallschritte", "Beinstrecker", "Beinbeuger", "Waden"] },
            Full: { t: "Gym: Ganzkörper", d: "Erhalt & Maschinen", ex: ["Beinpresse", "Brustpresse", "Rudern", "Latzug", "Schulterpresse"] }
        };

        function getAdaptationFactor(currentWeek) {
            if (currentWeek === 0) return 1.0;
            let sum = 0, cnt = 0;
            const weekPrefix = `w${currentWeek - 1}`;
            
            Object.keys(state.logs).forEach(key => {
                if (key.startsWith(weekPrefix) && state.logs[key].run && state.logs[key].run.rpe) {
                    sum += parseInt(state.logs[key].run.rpe);
                    cnt++;
                }
            });
            
            if (cnt === 0) return 1.0;
            const avg = sum / cnt;
            if (avg > 8) return 0.9;
            if (avg < 4) return 1.1;
            return 1.0;
        }

        function generatePlan(weekIdx) {
            const config = state.configs[weekIdx] || { uni: ['Montag','Donnerstag'], vol: true, bike: [] };
            const days = Array(7).fill(null);
            const adaptFactor = getAdaptationFactor(weekIdx);

            // 1. Volleyball
            if (config.vol) {
                days[1] = { type: 'vol', title: "Volleyball", desc: "HIIT Ersatz.", id: `w${weekIdx}d1` };
            }

            // 2. Long Run (Tapering)
            let lrDist, lrTitle = "Long Run", lrDesc = "Zone 2. Pace egal.";
            if (weekIdx === 13) { lrDist = 21.1; lrTitle = "HALBMARATHON"; lrDesc = "Viel Erfolg!"; }
            else if (weekIdx === 12) { lrDist = 12.0; lrTitle = "Taper Run"; lrDesc = "Erholung."; }
            else if (weekIdx === 11) lrDist = 19.0;
            else if (weekIdx === 10) lrDist = 17.5;
            else { 
                const raw = 6 + (weekIdx * 1.1); 
                lrDist = Math.min(raw, 16.5); 
            }

            if (weekIdx < 12) lrDist = (lrDist * adaptFactor).toFixed(1);
            else if (weekIdx !== 13) lrDist = lrDist.toFixed(1);

            const lr = { type: 'run', subtype: 'long', title: weekIdx===13 ? lrTitle : `${lrTitle} (${lrDist} km)`, desc: lrDesc };
            if (!days[6]) days[6] = { ...lr, id: `w${weekIdx}d6` };
            else if (!days[5]) days[5] = { ...lr, id: `w${weekIdx}d5` };

            // 3. Gym
            const availGym = config.uni.filter(ud => days[weekDays.indexOf(ud)] === null);
            const gymCount = availGym.length >= 3 ? 3 : 2;
            let placed = 0;

            availGym.forEach(ud => {
                if (placed >= gymCount) return;
                const i = weekDays.indexOf(ud);
                let wo = splits.Full;
                if (gymCount === 2) wo = (placed === 0) ? splits.Upper : splits.Lower;
                if (gymCount === 3) wo = [splits.Push, splits.Pull, splits.Legs][placed];
                if (weekIdx >= 12) wo = { ...splits.Full, title: "Gym: Erhalt", desc: "Leicht." };

                days[i] = { type: 'gym', ...wo, id: `w${weekIdx}d${i}` };
                placed++;
            });

            // 4. Easy Runs
            let runsNeeded = (config.vol ? 2 : 3) - 1;
            if (weekIdx === 13) runsNeeded = 1;

            const scoreDay = (i) => {
                if (days[i]) return -99;
                let s = 10;
                if (days[i-1]?.type === 'run' || days[i-1]?.type === 'vol') s -= 5;
                if (days[i+1]?.type === 'run' || days[i+1]?.type === 'vol') s -= 5;
                if (days[i-1]?.type === 'gym' && days[i-1].t.includes('Beine')) s -= 3;
                return s;
            };

            while (runsNeeded > 0) {
                let bestI = -1, maxS = -99;
                for (let i=0; i<7; i++) { const s = scoreDay(i); if(s > maxS) { maxS = s; bestI = i; } }
                if (bestI === -1) break;

                let baseDist = Math.min(5 + weekIdx * 0.5, 9);
                if (weekIdx === 12) baseDist = 6;
                if (weekIdx === 13) baseDist = 4;

                const dist = (baseDist * adaptFactor).toFixed(1);
                let wo = { type: 'run', subtype: 'easy', title: `Easy Run (${dist} km)`, desc: "Locker." };
                if (config.bike.includes(`w${weekIdx}d${bestI}`)) wo = { type: 'bike', title: "Ergometer 45min", desc: "Cardio." };
                
                days[bestI] = { ...wo, id: `w${weekIdx}d${bestI}` };
                runsNeeded--;
            }

            for (let i=0; i<7; i++) if (!days[i]) days[i] = { type: 'rest', title: "Recovery", id: `w${weekIdx}d${i}` };

            return days.map(d => ({ 
                ...d, 
                // Restore correct property names for display
                title: d.title || d.t,
                desc: d.desc || d.d,
                exercises: d.exercises || d.ex,
                done: state.logs[d.id]?.done 
            }));
        }

        // --- 4. RENDER ENGINE (Vanilla JS) ---

        function render() {
            const app = document.getElementById('app');
            // Theme toggle
            if (state.darkMode) document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');

            // Header
            let html = `
                <div class="flex justify-between items-center mb-6 bg-white dark:bg-slate-900 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-800">
                    <div>
                        <h1 class="text-xl font-bold text-slate-800 dark:text-white">Hybrid V24</h1>
                        <div class="text-xs text-slate-400">Native Core</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="text-xs font-bold bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-2 py-1 rounded">
                            ${state.week < 5 ? "Base" : state.week < 10 ? "Build" : state.week < 12 ? "Peak" : "Race"} Phase
                        </div>
                        <button onclick="actions.toggleTheme()" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-600 dark:text-slate-300">
                            ${state.darkMode ? icons.sun : icons.moon}
                        </button>
                    </div>
                </div>
            `;

            // Nav
            html += `
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-2 bg-white dark:bg-slate-900 p-2 rounded-lg border dark:border-slate-800">
                        <button onclick="actions.changeWeek(-1)" class="p-2 text-slate-600 dark:text-slate-300">${icons.left}</button>
                        <span class="text-sm font-bold w-16 text-center dark:text-white">W${state.week + 1}</span>
                        <button onclick="actions.changeWeek(1)" class="p-2 text-slate-600 dark:text-slate-300">${icons.right}</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="actions.openSetup()" class="bg-slate-900 dark:bg-blue-600 text-white px-3 py-2 rounded-lg text-xs font-bold">Setup</button>
                        <button onclick="actions.toggleView()" class="bg-white dark:bg-slate-900 border dark:border-slate-800 text-slate-600 dark:text-slate-300 px-3 py-2 rounded-lg text-xs font-bold">
                            ${state.view === 'plan' ? icons.chart : icons.cal}
                        </button>
                    </div>
                </div>
            `;

            // Content
            if (state.view === 'plan') {
                const adaptFactor = getAdaptationFactor(state.week);
                if (adaptFactor !== 1.0) {
                    html += `
                        <div class="mb-4 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-800 dark:text-indigo-300 p-3 rounded-lg text-xs font-bold border border-indigo-100 dark:border-indigo-900 flex items-center gap-2">
                            ${icons.brain} AI: ${adaptFactor > 1 ? '+10% Vol' : '-10% Vol'} (Bio-Feedback)
                        </div>
                    `;
                }

                const days = generatePlan(state.week);
                html += `<div class="space-y-3">`;
                days.forEach((day, i) => {
                    let icon = icons.rest;
                    if (day.type === 'gym') icon = icons.gym;
                    if (day.type === 'run') icon = icons.run;
                    if (day.type === 'bike') icon = icons.bike;
                    if (day.type === 'vol') icon = icons.vol;

                    let borderClass = 'opacity-60 border-l-4 border-slate-300';
                    if (day.type === 'gym') borderClass = 'border-l-4 border-blue-500';
                    if (day.type === 'run') borderClass = 'border-l-4 border-orange-500';
                    if (day.type === 'vol') borderClass = 'border-l-4 border-pink-500';
                    if (day.type === 'bike') borderClass = 'border-l-4 border-teal-500';

                    // Data for modal passed via data attributes (safe string)
                    const dayJson = encodeURIComponent(JSON.stringify(day));

                    html += `
                        <div onclick="actions.openDay('${dayJson}')" class="flex items-center p-3 rounded-xl border dark:border-slate-800 bg-white dark:bg-slate-900 shadow-sm active:scale-[0.98] trans-all cursor-pointer ${borderClass} ${day.done ? 'bg-green-50 dark:bg-green-900/20' : ''}">
                            <div class="w-16 text-xs font-bold text-slate-400 uppercase">${weekDays[i].substr(0,2)}</div>
                            <div class="flex-1">
                                <div class="font-bold text-slate-800 dark:text-white text-sm">${day.title}</div>
                                ${day.type !== 'rest' ? `<div class="text-xs text-slate-500 dark:text-slate-400">${day.desc}</div>` : ''}
                            </div>
                            <div class="text-slate-300 dark:text-slate-600">
                                ${day.done ? `<div class="bg-green-500 rounded-full p-1">${icons.check}</div>` : icon}
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            } else {
                // STATS
                html += renderStats();
            }

            app.innerHTML = html;
        }

        function renderStats() {
            // Stats logic here (simplified for native)
            let gymData = [], runData = [];
            for(let w=0; w<=state.week; w++) {
                let vol=0, dist=0;
                Object.keys(state.logs).forEach(k => {
                    if(k.startsWith(`w${w}d`)) {
                        const l = state.logs[k];
                        if(l.exercises) Object.values(l.exercises).forEach(s => s.forEach(x => vol += (x.w*x.r)||0));
                        if(l.run && l.run.dist) dist += parseFloat(l.run.dist);
                    }
                });
                gymData.push({w: w+1, v: vol});
                runData.push({w: w+1, v: dist});
            }
            
            const maxGym = Math.max(...gymData.map(d=>d.v), 1);
            const maxRun = Math.max(...runData.map(d=>d.v), 1);

            let html = `
                <div class="space-y-6 animate-fade-in">
                    <div class="bg-white dark:bg-slate-900 p-4 rounded-xl border dark:border-slate-800">
                        <h3 class="font-bold mb-4 flex gap-2 text-sm dark:text-white">${icons.gym} Gym Volumen (kg)</h3>
                        <div class="h-32 flex items-end gap-1">
                            ${gymData.map(d => `
                                <div class="flex-1 flex flex-col items-center">
                                    <div style="height:${(d.v/maxGym)*100}%" class="w-full bg-blue-500 rounded-t bar-grow min-h-[2px]"></div>
                                    <div class="text-[9px] text-slate-400 mt-1">${d.w}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="bg-white dark:bg-slate-900 p-4 rounded-xl border dark:border-slate-800">
                        <h3 class="font-bold mb-4 flex gap-2 text-sm dark:text-white">${icons.run} Lauf Distanz (km)</h3>
                        <div class="h-32 flex items-end gap-1">
                            ${runData.map(d => `
                                <div class="flex-1 flex flex-col items-center">
                                    <div style="height:${(d.v/maxRun)*100}%" class="w-full bg-orange-500 rounded-t bar-grow min-h-[2px]"></div>
                                    <div class="text-[9px] text-slate-400 mt-1">${d.w}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            return html;
        }

        // --- ACTIONS HANDLER ---
        const actions = {
            changeWeek: (d) => { state.week = Math.max(0, Math.min(13, state.week + d)); render(); },
            toggleTheme: () => { state.darkMode = !state.darkMode; localStorage.setItem(STORE.THEME, state.darkMode); render(); },
            toggleView: () => { state.view = state.view === 'plan' ? 'stats' : 'plan'; render(); },
            
            openSetup: () => {
                const config = state.configs[state.week] || { uni: [], vol: true };
                const modal = document.getElementById('modal-content');
                let btns = weekDays.map(d => {
                    const active = config.uni.includes(d);
                    return `<button onclick="actions.toggleUni('${d}')" class="p-2 text-xs border rounded ${active ? 'bg-blue-600 text-white' : 'bg-slate-50 dark:bg-slate-800 dark:text-slate-300 dark:border-slate-700'}">${d}</button>`;
                }).join('');

                modal.innerHTML = `
                    <div class="bg-slate-900 text-white p-4 flex justify-between items-center">
                        <h3 class="font-bold">Setup W${state.week+1}</h3>
                        <button onclick="closeModal()">${icons.close}</button>
                    </div>
                    <div class="p-6">
                        <p class="text-xs text-slate-400 mb-2 font-bold">UNI TAGE (Gym Prio)</p>
                        <div class="grid grid-cols-2 gap-2 mb-6">${btns}</div>
                        <button onclick="actions.toggleVol()" class="w-full p-3 border rounded text-xs font-bold mb-4 ${config.vol ? 'bg-pink-50 border-pink-500 text-pink-700' : 'bg-slate-50 dark:bg-slate-800 dark:text-slate-300'}">Volleyball (Di) ${config.vol?'AN':'AUS'}</button>
                        <div class="mb-4">
                            <label class="text-xs font-bold text-slate-400 block mb-1">Max HR</label>
                            <input type="number" value="${state.user.maxHR}" onchange="actions.saveHR(this.value)" class="w-full p-2 border rounded dark:bg-slate-800 dark:text-white dark:border-slate-700">
                        </div>
                    </div>
                `;
                document.getElementById('modal-overlay').classList.remove('hidden');
            },

            toggleUni: (d) => {
                const list = state.configs[state.week].uni;
                if(list.includes(d)) state.configs[state.week].uni = list.filter(x=>x!==d);
                else state.configs[state.week].uni.push(d);
                localStorage.setItem(STORE.CONF, JSON.stringify(state.configs));
                actions.openSetup(); // refresh modal
                render(); // background refresh
            },

            toggleVol: () => {
                state.configs[state.week].vol = !state.configs[state.week].vol;
                localStorage.setItem(STORE.CONF, JSON.stringify(state.configs));
                actions.openSetup();
                render();
            },

            saveHR: (val) => {
                state.user.maxHR = val;
                localStorage.setItem(STORE.USER, JSON.stringify(state.user));
            },

            openDay: (json) => {
                const day = JSON.parse(decodeURIComponent(json));
                const modal = document.getElementById('modal-content');
                const log = state.logs[day.id] || {};
                const run = log.run || { time:'', dist:'', rpe:5, bpm:'' };
                
                let content = '';
                if(day.type === 'gym') {
                    content = `<div class="space-y-4">`;
                    day.exercises.forEach((exName, i) => {
                        const exKey = exName.replace(/\s/g, '');
                        const sets = log.exercises?.[exKey] || [{w:'',r:''},{w:'',r:''},{w:'',r:''}];
                        content += `
                            <div class="pb-4 border-b dark:border-slate-800">
                                <div class="font-bold text-sm mb-2 dark:text-white">${exName}</div>
                                <div class="flex gap-2">
                                    ${sets.map((s, idx) => `
                                        <div class="flex gap-1">
                                            <input type="number" placeholder="kg" class="w-12 p-1 border rounded text-xs text-center dark:bg-slate-800 dark:text-white" value="${s.w}" onchange="actions.logGym('${day.id}','${exKey}',${idx},'w',this.value)">
                                            <input type="number" placeholder="rep" class="w-10 p-1 border rounded text-xs text-center dark:bg-slate-800 dark:text-white" value="${s.r}" onchange="actions.logGym('${day.id}','${exKey}',${idx},'r',this.value)">
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    });
                    content += `</div>`;
                } else if (day.type !== 'rest') {
                    content = `
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div><label class="text-xs text-slate-400">Zeit</label><input type="text" class="w-full p-2 border rounded dark:bg-slate-800 dark:text-white" value="${run.time}" onchange="actions.logRun('${day.id}','time',this.value)"></div>
                            <div><label class="text-xs text-slate-400">km</label><input type="number" class="w-full p-2 border rounded dark:bg-slate-800 dark:text-white" value="${run.dist}" onchange="actions.logRun('${day.id}','dist',this.value)"></div>
                        </div>
                        <div class="mb-4"><label class="text-xs text-slate-400 flex items-center gap-1">${icons.heart} Ø BPM</label><input type="number" class="w-full p-2 border rounded dark:bg-slate-800 dark:text-white" value="${run.bpm}" onchange="actions.logRun('${day.id}','bpm',this.value)"></div>
                        <div class="mb-4">
                            <label class="text-xs text-slate-400 flex justify-between">RPE (1-10) <span id="rpe-val">${run.rpe}</span></label>
                            <input type="range" min="1" max="10" class="w-full" value="${run.rpe}" oninput="document.getElementById('rpe-val').innerText=this.value; actions.logRun('${day.id}','rpe',this.value)">
                        </div>
                    `;
                    if(day.subtype==='easy' || day.type==='bike') {
                        const isBike = state.configs[state.week].bike.includes(day.id);
                        content += `<button onclick="actions.toggleBike('${day.id}')" class="w-full p-2 border rounded text-xs text-teal-600 flex justify-center gap-2 mb-4">${icons.bike} ${isBike?'Laufen':'Rad'}</button>`;
                    }
                } else {
                    content = `<p class="text-slate-500 text-sm">Ruhetag genießen.</p>`;
                }

                modal.innerHTML = `
                    <div class="bg-slate-900 text-white p-4 flex justify-between items-center">
                        <h3 class="font-bold truncate pr-4">${day.title}</h3>
                        <button onclick="closeModal()">${icons.close}</button>
                    </div>
                    <div class="p-6 max-h-[70vh] overflow-y-auto">
                        <p class="text-xs text-slate-400 mb-4">${day.desc}</p>
                        ${content}
                    </div>
                    <div class="p-4 border-t dark:border-slate-800 bg-slate-50 dark:bg-slate-900">
                        <button onclick="actions.finish('${day.id}')" class="w-full bg-slate-900 dark:bg-blue-600 text-white py-3 rounded-xl font-bold flex justify-center gap-2">${icons.save} Speichern & Fertig</button>
                    </div>
                `;
                document.getElementById('modal-overlay').classList.remove('hidden');
            },

            logGym: (id, exKey, idx, field, val) => {
                if(!state.logs[id]) state.logs[id] = { exercises: {} };
                if(!state.logs[id].exercises) state.logs[id].exercises = {};
                if(!state.logs[id].exercises[exKey]) state.logs[id].exercises[exKey] = [{w:'',r:''},{w:'',r:''},{w:'',r:''}];
                state.logs[id].exercises[exKey][idx][field] = val;
                localStorage.setItem(STORE.LOGS, JSON.stringify(state.logs));
            },

            logRun: (id, field, val) => {
                if(!state.logs[id]) state.logs[id] = { run: {} };
                if(!state.logs[id].run) state.logs[id].run = {};
                state.logs[id].run[field] = val;
                localStorage.setItem(STORE.LOGS, JSON.stringify(state.logs));
            },

            toggleBike: (id) => {
                const list = state.configs[state.week].bike;
                if(list.includes(id)) state.configs[state.week].bike = list.filter(x=>x!==id);
                else state.configs[state.week].bike.push(id);
                localStorage.setItem(STORE.CONF, JSON.stringify(state.configs));
                closeModal();
                render();
            },

            finish: (id) => {
                if(!state.logs[id]) state.logs[id] = {};
                state.logs[id].done = true;
                localStorage.setItem(STORE.LOGS, JSON.stringify(state.logs));
                closeModal();
                render();
            }
        };

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }

        // Init App
        render();

    </script>
</body>
</html>
