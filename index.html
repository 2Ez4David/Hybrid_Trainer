import React, { useState, useEffect, useMemo } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, BarChart, Bar, AreaChart, Area } from 'recharts';
import { Dumbbell, Footprints, Bike, Volleyball, Moon, Sun, ChevronLeft, ChevronRight, Settings, BarChart2, Save, Brain, Check, Info, X, TrendingUp, Activity, Timer } from 'lucide-react';

export default function HybridCoach() {
  const [week, setWeek] = useState(0);
  const [view, setView] = useState('plan'); // 'plan', 'stats'
  const [statsSubView, setStatsSubView] = useState('overview'); // 'overview', 'details'
  const [selectedExercise, setSelectedExercise] = useState(null);
  const [darkMode, setDarkMode] = useState(false);
  const [showSetup, setShowSetup] = useState(false);
  const [selectedDay, setSelectedDay] = useState(null);

  // --- CONFIG ---
  const [configs, setConfigs] = useState(() => {
    try { return JSON.parse(localStorage.getItem('hybrid_conf_final')) || Array(14).fill(null).map(() => ({ uni: ['Montag','Donnerstag'], vol: true, bike: [] })); } 
    catch { return Array(14).fill(null).map(() => ({ uni: ['Montag','Donnerstag'], vol: true, bike: [] })); }
  });
  
  const [logs, setLogs] = useState(() => {
    try { return JSON.parse(localStorage.getItem('hybrid_logs_final')) || {}; } 
    catch { return {}; }
  });

  const [userSettings, setUserSettings] = useState(() => {
    try { return JSON.parse(localStorage.getItem('hybrid_user_final')) || { maxHR: 190 }; }
    catch { return { maxHR: 190 }; }
  });

  // Persistence
  useEffect(() => localStorage.setItem('hybrid_conf_final', JSON.stringify(configs)), [configs]);
  useEffect(() => localStorage.setItem('hybrid_logs_final', JSON.stringify(logs)), [logs]);
  useEffect(() => localStorage.setItem('hybrid_user_final', JSON.stringify(userSettings)), [userSettings]);
  
  useEffect(() => {
    if (darkMode) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');
  }, [darkMode]);

  // --- CONSTANTS ---
  const weekDays = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
  
  const splits = {
    Upper: { t: "Gym: Oberk√∂rper", d: "Kraft & Hypertrophie", ex: ["Bankdr√ºcken (Maschine)", "Rudern", "Schulterpresse", "Latzug", "Trizeps", "Bizeps"] },
    Lower: { t: "Gym: Beine", d: "Kraft (Maschine)", ex: ["Beinpresse", "Beinstrecker", "Beinbeuger", "Wadenheben", "Abduktoren", "Core"] },
    Push: { t: "Gym: Push", d: "Brust/Schulter/Trizeps", ex: ["Brustpresse", "Schulterpresse", "Seitheben", "Trizepsdr√ºcken", "Butterfly"] },
    Pull: { t: "Gym: Pull", d: "R√ºcken/Bizeps", ex: ["Latzug", "Rudern", "Face Pulls", "Bizeps Curls", "Butterfly Reverse"] },
    Legs: { t: "Gym: Beine", d: "Unterk√∂rper Fokus", ex: ["Beinpresse", "Ausfallschritte", "Beinstrecker", "Beinbeuger", "Waden"] },
    Full: { t: "Gym: Ganzk√∂rper", d: "Erhalt & Maschinen", ex: ["Beinpresse", "Brustpresse", "Rudern", "Latzug", "Schulterpresse", "R√ºckenstrecker"] }
  };

  // --- LOGIC: PHASE INFO ---
  const getPhaseDetails = (w) => {
    if (w < 5) return { title: "Base Phase", focus: "Grundlagenausdauer & Gew√∂hnung" };
    if (w < 10) return { title: "Build Phase", focus: "Steigerung von Volumen & Intensit√§t" };
    if (w < 12) return { title: "Peak Phase", focus: "Maximale Belastung vor dem Rennen" };
    if (w === 12) return { title: "Taper Phase", focus: "Erholung & Speicher f√ºllen" };
    return { title: "Race Week", focus: "Minimale Belastung. Race Day!" };
  };

  const currentPhase = getPhaseDetails(week);

  // --- LOGIC: ADAPTATION ---
  const adaptFactor = useMemo(() => {
    if (week === 0) return 1.0;
    let rpeSum = 0, bpmSum = 0, count = 0;
    
    Object.keys(logs).forEach(k => {
      if (k.startsWith(`w${week-1}`) && logs[k].run) {
        if (logs[k].run.rpe) rpeSum += parseInt(logs[k].run.rpe);
        if (logs[k].run.bpm) bpmSum += parseInt(logs[k].run.bpm);
        count++;
      }
    });

    if (count === 0) return 1.0;
    const avgRPE = rpeSum / count;
    const avgBPM = bpmSum > 0 ? bpmSum / count : 0;
    const maxHR = parseInt(userSettings.maxHR) || 190;
    
    if (avgBPM > (maxHR * 0.78)) return 0.9; 
    if (avgRPE > 8) return 0.9;
    if (avgRPE < 4) return 1.1;

    return 1.0;
  }, [week, logs, userSettings.maxHR]);

  // --- LOGIC: PLAN GENERATION ---
  const generatePlan = (wIdx) => {
    const cfg = configs[wIdx] || { uni: [], vol: true, bike: [] };
    const days = Array(7).fill(null);
    const factor = adaptFactor;

    // 1. Volleyball
    if (cfg.vol) days[1] = { type: 'vol', title: "Volleyball", desc: "HIIT Ersatz & Sprungkraft", id: `w${wIdx}d1` };

    // 2. Long Run (14 Weeks Logic)
    let lrDist;
    let lrTitle = "Long Run";
    let lrDesc = "Zone 2. Pace egal.";

    if (wIdx === 13) { 
        lrDist = 21.1; lrTitle = "HALBMARATHON"; lrDesc = "Viel Erfolg! Du hast es geschafft.";
    } 
    else if (wIdx === 12) {
        lrDist = 10.0; lrTitle = "Taper Run"; lrDesc = "Erholung. Beine frisch machen.";
    }
    else if (wIdx === 11) {
        lrDist = 18.0; 
    }
    else {
        const raw = 7 + (wIdx * 1.0);
        lrDist = Math.min(raw, 17.0);
    }
    
    if (wIdx < 12) lrDist = (lrDist * factor).toFixed(1);
    else if (wIdx !== 13) lrDist = lrDist.toFixed(1);

    const lr = { type: 'run', subtype: 'long', title: wIdx === 13 ? lrTitle : `${lrTitle} (${lrDist} km)`, desc: lrDesc };
    
    // Place Sunday (preferred) or Saturday
    if (!days[6]) days[6] = { ...lr, id: `w${wIdx}d6` };
    else if (!days[5]) days[5] = { ...lr, id: `w${wIdx}d5` };

    // 3. Gym Placement
    const availGym = cfg.uni.filter(d => days[weekDays.indexOf(d)] === null);
    const gymCount = availGym.length >= 3 ? 3 : 2;
    let placed = 0;
    
    availGym.forEach(d => {
      if (placed >= gymCount) return;
      const idx = weekDays.indexOf(d);
      let wo = splits.Full;
      if (gymCount === 2) wo = (placed === 0) ? splits.Upper : splits.Lower;
      if (gymCount === 3) wo = [splits.Push, splits.Pull, splits.Legs][placed];
      
      if (wIdx >= 12) wo = { ...splits.Full, title: "Gym: Erhalt (Leicht)", desc: "Nur Bewegung, keine Erm√ºdung." };

      days[idx] = { type: 'gym', ...wo, id: `w${wIdx}d${idx}` };
      placed++;
    });

    // 4. Run Filling
    let needed = (cfg.vol ? 2 : 3) - 1; 
    if (wIdx === 13) needed = 1;

    const score = (i) => {
      if (days[i]) return -99;
      let s = 10;
      // Avoid stacking cardio
      if (days[i-1]?.type?.match(/run|vol/)) s -= 5;
      if (days[i+1]?.type?.match(/run|vol/)) s -= 5;
      // Avoid running after Leg day immediately
      if (days[i-1]?.type === 'gym' && days[i-1].t.includes('Beine')) s -= 3;
      return s;
    };

    while (needed > 0) {
      let best = -1, max = -99;
      for (let i=0; i<7; i++) { const s = score(i); if(s>max) { max=s; best=i; } }
      if (best === -1) break;
      
      let baseDist = Math.min(5 + wIdx * 0.5, 9);
      if (wIdx === 12) baseDist = 5; // Taper
      if (wIdx === 13) baseDist = 3; // Shakeout

      const dist = (baseDist * factor).toFixed(1);
      let wo = { type: 'run', subtype: 'easy', title: `Easy Run (${dist} km)`, desc: wIdx === 13 ? "Shakeout Run" : "Locker." };
      
      if (cfg.bike.includes(`w${wIdx}d${best}`)) wo = { type: 'bike', title: "Ergometer 45min", desc: "Cardio (Gelenkschonend)" };
      
      days[best] = { ...wo, id: `w${wIdx}d${best}` };
      needed--;
    }

    // 5. Rest
    for(let i=0; i<7; i++) if(!days[i]) days[i] = { type: 'rest', title: "Recovery", id: `w${wIdx}d${i}` };
    
    return days.map(d => ({ 
        ...d, 
        title: d.title || d.t,
        desc: d.desc || d.d,
        exercises: d.exercises || d.ex,
        done: logs[d.id]?.done 
    }));
  };

  const days = generatePlan(week);

  // --- STATS DATA HELPERS ---
  const getAllExercises = () => {
    const gymSet = new Set();
    Object.values(splits).forEach(s => s.ex.forEach(e => gymSet.add(e)));
    return {
        gym: Array.from(gymSet).sort(),
        run: ["Long Run", "Easy Run"]
    };
  };

  const getExerciseData = (exName) => {
    const data = [];
    for(let w=0; w<14; w++) {
        let bestVal = 0;
        let found = false;
        
        for(let d=0; d<7; d++) {
            const id = `w${w}d${d}`;
            const log = logs[id];
            if(!log) continue;

            const exKey = exName.replace(/\s/g,'');
            
            // Check Gym
            if(log.exercises && log.exercises[exKey]) {
                const maxW = Math.max(...log.exercises[exKey].map(s => parseFloat(s.w) || 0));
                if(maxW > bestVal) bestVal = maxW;
                found = true;
            }

            // Check Run
            if(log.run && log.run.dist && log.run.time) {
                const dist = parseFloat(log.run.dist);
                const timeParts = log.run.time.split(':');
                const mins = parseFloat(timeParts[0]) + (parseFloat(timeParts[1]||0)/60);
                
                if(dist > 0 && mins > 0) {
                    const pace = mins / dist;
                    if(exName === "Long Run" && dist > 10) { bestVal = pace; found = true; }
                    else if(exName === "Easy Run" && dist <= 10) { bestVal = pace; found = true; }
                }
            }
        }
        if(found) data.push({ name: `W${w+1}`, value: bestVal });
    }
    return data;
  };

  // NEW: Comprehensive Stats Logic
  const getFullStats = () => {
    const data = [];
    let grandTotalKm = 0;
    let grandTotalKg = 0;
    let totalRPE = 0;
    let rpeCount = 0;
    let completedCount = 0;

    for(let w=0; w<=week; w++) {
        let vol = 0; 
        let dist = 0;
        let paceSum = 0;
        let runCount = 0;
        
        Object.keys(logs).forEach(key => {
            if (key.startsWith(`w${w}d`)) {
                const log = logs[key];
                
                if(log.done) completedCount++;

                if(log.exercises) {
                    Object.values(log.exercises).forEach(sets => {
                        sets.forEach(s => {
                            const w = parseFloat(s.w) || 0;
                            const r = parseFloat(s.r) || 0;
                            vol += w * r; // Progression Check: Volume Load
                        });
                    });
                }
                
                if(log.run) {
                    const d = parseFloat(log.run.dist) || 0;
                    dist += d; // Progression Check: Distance Accumulation
                    
                    if(d > 0 && log.run.time) {
                        const t = log.run.time.split(':');
                        const m = parseFloat(t[0]) + (parseFloat(t[1]||0)/60);
                        if(m > 0) {
                            paceSum += (m / d);
                            runCount++;
                        }
                    }
                    if(log.run.rpe) {
                        totalRPE += parseFloat(log.run.rpe);
                        rpeCount++;
                    }
                }
            }
        });

        grandTotalKg += vol;
        grandTotalKm += dist;

        data.push({ 
            name: `W${w+1}`, 
            vol, 
            dist,
            pace: runCount ? (paceSum/runCount).toFixed(2) : 0
        });
    }

    return { 
        chartData: data, 
        totalKm: grandTotalKm.toFixed(1), 
        totalKg: (grandTotalKg / 1000).toFixed(1), // In Tons
        avgRPE: rpeCount ? (totalRPE / rpeCount).toFixed(1) : '-',
        completed: completedCount
    };
  };

  const fullStats = getFullStats();

  // --- ACTIONS ---
  const toggleUni = (d) => {
    const n = [...configs];
    const list = n[week].uni;
    if (list.includes(d)) n[week].uni = list.filter(x => x !== d); else n[week].uni.push(d);
    setConfigs(n);
  };

  const toggleVol = () => {
    const n = [...configs];
    n[week].vol = !n[week].vol;
    setConfigs(n);
  };

  const toggleBike = (id) => {
    const n = [...configs];
    const list = n[week].bike;
    if(list.includes(id)) n[week].bike = list.filter(x => x !== id); else n[week].bike.push(id);
    setConfigs(n);
    setSelectedDay(null); // Close modal
  };

  // --- UI RENDER ---
  return (
    <div className={`min-h-screen pb-20 ${darkMode ? 'bg-slate-950 text-slate-100' : 'bg-slate-50 text-slate-900'} font-sans transition-colors duration-300`}>
      <div className="max-w-md mx-auto p-4">
        
        {/* HEADER */}
        <div className={`flex justify-between items-center mb-4 p-4 rounded-xl shadow-sm border ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
          <div>
            <h1 className="text-xl font-bold">Hybrid Coach</h1>
            <div className="text-xs opacity-60">14 Wochen Plan</div>
          </div>
          <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-full ${darkMode ? 'bg-slate-800' : 'bg-slate-100'}`}>
              {darkMode ? <Sun size={18} /> : <Moon size={18} />}
          </button>
        </div>

        {/* PHASE INFO */}
        <div className={`mb-6 p-4 rounded-xl shadow-sm border flex items-start gap-4 ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
            <div className={`p-2 rounded-full ${darkMode ? 'bg-blue-900/30 text-blue-400' : 'bg-blue-50 text-blue-600'}`}>
                <Info size={20} />
            </div>
            <div>
                <h3 className={`font-bold text-sm mb-1 ${darkMode ? 'text-white' : 'text-slate-900'}`}>
                    {currentPhase.title}: Woche {week + 1}
                </h3>
                <p className={`text-xs ${darkMode ? 'text-slate-400' : 'text-slate-500'}`}>
                    {currentPhase.focus}
                </p>
            </div>
        </div>

        {/* NAVIGATION */}
        <div className="flex justify-between items-center mb-6">
            <div className={`flex items-center gap-2 p-2 rounded-lg border ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                <button onClick={() => setWeek(Math.max(0, week - 1))} className="p-1"><ChevronLeft /></button>
                <span className="text-sm font-bold w-12 text-center">W{week + 1}</span>
                <button onClick={() => setWeek(Math.min(13, week + 1))} className="p-1"><ChevronRight /></button>
            </div>
            <div className="flex gap-2">
                <button onClick={() => setShowSetup(true)} className={`px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-1 ${darkMode ? 'bg-blue-600 text-white' : 'bg-slate-900 text-white'}`}>
                    <Settings size={14} /> Setup
                </button>
                <button onClick={() => setView(view === 'plan' ? 'stats' : 'plan')} className={`px-3 py-2 rounded-lg text-xs font-bold border ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                    <BarChart2 size={16} />
                </button>
            </div>
        </div>

        {/* MAIN CONTENT */}
        {view === 'plan' ? (
            <div className="space-y-3 fade-in">
                {adaptFactor !== 1.0 && (
                    <div className={`mb-4 p-3 rounded-xl text-xs font-bold border flex items-center gap-2 ${darkMode ? 'bg-indigo-900/30 text-indigo-300 border-indigo-900' : 'bg-indigo-50 text-indigo-800 border-indigo-100'}`}>
                        <Brain size={16} /> AI: {adaptFactor > 1 ? '+10% Volumen' : '-10% Volumen'}
                    </div>
                )}

                {days.map((day, i) => (
                    <div 
                        key={i} 
                        onClick={() => setSelectedDay(day)}
                        className={`
                            flex items-center p-3 rounded-xl border shadow-sm cursor-pointer transition-all active:scale-[0.98]
                            ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}
                            ${day.type === 'gym' ? 'border-l-4 border-l-blue-500' : ''}
                            ${day.type === 'run' ? 'border-l-4 border-l-orange-500' : ''}
                            ${day.type === 'vol' ? 'border-l-4 border-l-pink-500' : ''}
                            ${day.type === 'bike' ? 'border-l-4 border-l-teal-500' : ''}
                            ${day.done ? (darkMode ? 'bg-green-900/20' : 'bg-green-50') : ''}
                        `}
                    >
                        <div className="w-12 text-xs font-bold opacity-50 uppercase">{weekDays[i].substr(0, 2)}</div>
                        <div className="flex-1">
                            <div className="font-bold text-sm">{day.title}</div>
                            {day.type !== 'rest' && <div className="text-xs opacity-60">{day.desc}</div>}
                        </div>
                        <div className="text-slate-300">
                            {day.done ? <div className="bg-green-500 text-white rounded-full p-1"><Check size={14} /></div> : 
                             day.type === 'gym' ? <Dumbbell size={20} className="text-blue-500" /> :
                             day.type === 'run' ? <Footprints size={20} className="text-orange-500" /> :
                             day.type === 'bike' ? <Bike size={20} className="text-teal-500" /> :
                             day.type === 'vol' ? <Volleyball size={20} className="text-pink-500" /> :
                             <div className="w-2 h-2 bg-slate-300 rounded-full"></div>
                            }
                        </div>
                    </div>
                ))}
            </div>
        ) : (
            <div className="fade-in space-y-6">
                <div className="flex justify-between mb-4">
                    <button onClick={() => setView('plan')} className="text-sm font-bold flex items-center gap-1 opacity-60"><ChevronLeft size={16}/> Zur√ºck</button>
                    <div className={`flex p-1 rounded-lg border ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                        <button onClick={() => setStatsSubView('overview')} className={`px-3 py-1 text-xs font-bold rounded ${statsSubView === 'overview' ? (darkMode ? 'bg-blue-600 text-white' : 'bg-slate-900 text-white') : 'opacity-60'}`}>√úbersicht</button>
                        <button onClick={() => setStatsSubView('details')} className={`px-3 py-1 text-xs font-bold rounded ${statsSubView === 'details' ? (darkMode ? 'bg-blue-600 text-white' : 'bg-slate-900 text-white') : 'opacity-60'}`}>Details</button>
                    </div>
                </div>

                {statsSubView === 'overview' ? (
                    <div className="space-y-6">
                        
                        {/* Summary Cards */}
                        <div className="grid grid-cols-3 gap-3">
                            <div className={`p-3 rounded-xl border text-center ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                                <div className="text-xs opacity-50 mb-1">Laufen</div>
                                <div className="font-bold text-lg text-orange-500">{fullStats.totalKm} <span className="text-xs text-slate-400">km</span></div>
                            </div>
                            <div className={`p-3 rounded-xl border text-center ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                                <div className="text-xs opacity-50 mb-1">Last</div>
                                <div className="font-bold text-lg text-blue-500">{fullStats.totalKg} <span className="text-xs text-slate-400">t</span></div>
                            </div>
                            <div className={`p-3 rounded-xl border text-center ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                                <div className="text-xs opacity-50 mb-1">RPE</div>
                                <div className="font-bold text-lg text-purple-500">{fullStats.avgRPE}</div>
                            </div>
                        </div>

                        {/* Pace Chart */}
                        <div className={`p-4 rounded-xl border ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                            <h3 className="font-bold text-sm mb-4 flex gap-2"><Timer size={16}/> Pace Entwicklung (min/km)</h3>
                            <div className="h-40">
                                <ResponsiveContainer width="100%" height="100%">
                                    <LineChart data={fullStats.chartData}>
                                        <CartesianGrid strokeDasharray="3 3" opacity={0.1} />
                                        <XAxis dataKey="name" fontSize={10} tickLine={false} axisLine={false} />
                                        <Tooltip contentStyle={{backgroundColor: darkMode ? '#1e293b' : '#fff', borderRadius: '8px', border: 'none'}} />
                                        <Line type="monotone" dataKey="pace" stroke="#10b981" strokeWidth={3} dot={{r: 3}} />
                                    </LineChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        <div className={`p-4 rounded-xl border ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                            <h3 className="font-bold text-sm mb-4 flex gap-2"><Dumbbell size={16}/> Gym Volumen (Last)</h3>
                            <div className="h-40">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={fullStats.chartData}>
                                        <CartesianGrid strokeDasharray="3 3" opacity={0.1} />
                                        <XAxis dataKey="name" fontSize={10} tickLine={false} axisLine={false} />
                                        <Tooltip contentStyle={{backgroundColor: darkMode ? '#1e293b' : '#fff', borderRadius: '8px', border: 'none'}} />
                                        <Bar dataKey="vol" fill="#3b82f6" radius={[4, 4, 0, 0]} />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                        <div className={`p-4 rounded-xl border ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                            <h3 className="font-bold text-sm mb-4 flex gap-2"><Footprints size={16}/> Lauf Distanz (km)</h3>
                            <div className="h-40">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={fullStats.chartData}>
                                        <CartesianGrid strokeDasharray="3 3" opacity={0.1} />
                                        <XAxis dataKey="name" fontSize={10} tickLine={false} axisLine={false} />
                                        <Tooltip contentStyle={{backgroundColor: darkMode ? '#1e293b' : '#fff', borderRadius: '8px', border: 'none'}} />
                                        <Bar dataKey="dist" fill="#f97316" radius={[4, 4, 0, 0]} />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>
                ) : (
                    <div className={`p-4 rounded-xl border ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                        <h3 className="font-bold text-sm mb-4">√úbungs-Analyse</h3>
                        <select 
                            className={`w-full p-2 mb-4 rounded border text-sm ${darkMode ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-slate-200'}`}
                            onChange={(e) => setSelectedExercise(e.target.value)}
                            value={selectedExercise || ""}
                        >
                            <option value="" disabled>W√§hle eine √úbung...</option>
                            <optgroup label="Laufen">
                                {getAllExercises().run.map(e => <option key={e} value={e}>{e}</option>)}
                            </optgroup>
                            <optgroup label="Gym">
                                {getAllExercises().gym.map(e => <option key={e} value={e}>{e}</option>)}
                            </optgroup>
                        </select>

                        {selectedExercise && getExerciseData(selectedExercise).length > 0 ? (
                            <div className="h-60 mt-4">
                                <ResponsiveContainer width="100%" height="100%">
                                    <LineChart data={getExerciseData(selectedExercise)}>
                                        <CartesianGrid strokeDasharray="3 3" opacity={0.1} />
                                        <XAxis dataKey="name" fontSize={10} tickLine={false} axisLine={false} />
                                        <YAxis fontSize={10} tickLine={false} axisLine={false} width={30} />
                                        <Tooltip contentStyle={{backgroundColor: darkMode ? '#1e293b' : '#fff', borderRadius: '8px', border: 'none'}} />
                                        <Line type="monotone" dataKey="value" stroke={selectedExercise.includes('Run') ? '#f97316' : '#3b82f6'} strokeWidth={3} dot={{r: 4}} />
                                    </LineChart>
                                </ResponsiveContainer>
                                <p className="text-center text-xs opacity-50 mt-2">
                                    {selectedExercise.includes('Run') ? 'Pace (min/km)' : 'Max Gewicht (kg)'}
                                </p>
                            </div>
                        ) : (
                            <div className="text-center py-10 opacity-40 text-sm">Keine Daten verf√ºgbar</div>
                        )}
                    </div>
                )}
            </div>
        )}

        {/* --- MODALS --- */}
        {showSetup && (
            <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setShowSetup(false)}>
                <div className={`w-full max-w-sm rounded-2xl p-6 shadow-2xl ${darkMode ? 'bg-slate-900' : 'bg-white'}`} onClick={e => e.stopPropagation()}>
                    <h3 className="font-bold mb-4">Einstellungen W{week+1}</h3>
                    <p className="text-xs opacity-60 mb-2">UNI TAGE (Gym Prio)</p>
                    <div className="grid grid-cols-2 gap-2 mb-4">
                        {weekDays.map(d => (
                            <button 
                                key={d}
                                onClick={() => toggleUni(d)}
                                className={`p-2 text-xs border rounded transition-colors ${configs[week].uni.includes(d) ? 'bg-blue-600 text-white border-blue-600' : (darkMode ? 'border-slate-700 hover:bg-slate-800' : 'border-slate-200 hover:bg-slate-50')}`}
                            >
                                {d}
                            </button>
                        ))}
                    </div>
                    <div className="mb-4">
                        <label className="text-xs font-bold opacity-60 block mb-1">Max HR (f√ºr AI)</label>
                        <input type="number" className={`w-full p-2 border rounded ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`} value={userSettings.maxHR} onChange={e => setUserSettings({...userSettings, maxHR: e.target.value})} />
                    </div>
                    <button 
                        onClick={() => { const n = [...configs]; n[week].vol = !n[week].vol; setConfigs(n); }}
                        className={`w-full p-3 border rounded text-xs font-bold ${configs[week].vol ? 'bg-pink-50 border-pink-500 text-pink-700 dark:bg-pink-900/30 dark:text-pink-300' : (darkMode ? 'border-slate-700' : 'border-slate-200')}`}
                    >
                        Volleyball (Di) {configs[week].vol ? 'AN' : 'AUS'}
                    </button>
                </div>
            </div>
        )}

        {selectedDay && (
            <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setSelectedDay(null)}>
                <div className={`w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl flex flex-col max-h-[85vh] ${darkMode ? 'bg-slate-900' : 'bg-white'}`} onClick={e => e.stopPropagation()}>
                    <div className={`p-4 text-white flex justify-between items-center ${darkMode ? 'bg-slate-950' : 'bg-slate-900'}`}>
                        <h3 className="font-bold">{selectedDay.title}</h3>
                        <button onClick={() => setSelectedDay(null)}><X size={20} /></button>
                    </div>
                    <div className="p-6 overflow-y-auto">
                        <p className="text-sm opacity-60 mb-4">{selectedDay.desc}</p>
                        
                        {/* Gym Inputs */}
                        {selectedDay.type === 'gym' && selectedDay.exercises.map((ex, i) => {
                            const key = ex.replace(/\s/g, '');
                            const sets = logs[selectedDay.id]?.exercises?.[key] || [{w:'',r:''},{w:'',r:''},{w:'',r:''}];
                            return (
                                <div key={i} className={`mb-3 pb-2 border-b ${darkMode ? 'border-slate-800' : 'border-slate-100'}`}>
                                    <div className="text-sm font-bold mb-1">{ex}</div>
                                    <div className="flex gap-2">
                                        {sets.map((s, idx) => (
                                            <div key={idx} className="flex gap-1">
                                                <input 
                                                    type="number" placeholder="kg" 
                                                    className={`w-12 p-1 text-center text-xs border rounded ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-50 border-slate-200'}`}
                                                    value={s.w}
                                                    onChange={(e) => {
                                                        const nLogs = {...logs};
                                                        if(!nLogs[selectedDay.id]) nLogs[selectedDay.id] = { exercises: {} };
                                                        if(!nLogs[selectedDay.id].exercises) nLogs[selectedDay.id].exercises = {};
                                                        if(!nLogs[selectedDay.id].exercises[key]) nLogs[selectedDay.id].exercises[key] = [...sets];
                                                        nLogs[selectedDay.id].exercises[key][idx].w = e.target.value;
                                                        setLogs(nLogs);
                                                    }}
                                                />
                                                <input 
                                                    type="number" placeholder="rp" 
                                                    className={`w-10 p-1 text-center text-xs border rounded ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-50 border-slate-200'}`}
                                                    value={s.r}
                                                    onChange={(e) => {
                                                        const nLogs = {...logs};
                                                        if(!nLogs[selectedDay.id]) nLogs[selectedDay.id] = { exercises: {} };
                                                        if(!nLogs[selectedDay.id].exercises) nLogs[selectedDay.id].exercises = {};
                                                        if(!nLogs[selectedDay.id].exercises[key]) nLogs[selectedDay.id].exercises[key] = [...sets];
                                                        nLogs[selectedDay.id].exercises[key][idx].r = e.target.value;
                                                        setLogs(nLogs);
                                                    }}
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            );
                        })}

                        {/* Run Inputs */}
                        {selectedDay.type !== 'rest' && selectedDay.type !== 'gym' && (
                            <div className="space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-xs opacity-60">Zeit</label>
                                        <input 
                                            className={`w-full p-2 border rounded ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`} 
                                            placeholder="45:00"
                                            value={logs[selectedDay.id]?.run?.time || ''}
                                            onChange={(e) => {
                                                const n = {...logs}; if(!n[selectedDay.id]) n[selectedDay.id]={run:{}}; if(!n[selectedDay.id].run) n[selectedDay.id].run={};
                                                n[selectedDay.id].run.time = e.target.value; setLogs(n);
                                            }}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs opacity-60">km</label>
                                        <input 
                                            type="number" 
                                            className={`w-full p-2 border rounded ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`} 
                                            placeholder="5.0"
                                            value={logs[selectedDay.id]?.run?.dist || ''}
                                            onChange={(e) => {
                                                const n = {...logs}; if(!n[selectedDay.id]) n[selectedDay.id]={run:{}}; if(!n[selectedDay.id].run) n[selectedDay.id].run={};
                                                n[selectedDay.id].run.dist = e.target.value; setLogs(n);
                                            }}
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label className="text-xs opacity-60">√ò BPM</label>
                                    <input 
                                        type="number" 
                                        className={`w-full p-2 border rounded ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'}`} 
                                        placeholder="145"
                                        value={logs[selectedDay.id]?.run?.bpm || ''}
                                        onChange={(e) => {
                                            const n = {...logs}; if(!n[selectedDay.id]) n[selectedDay.id]={run:{}}; if(!n[selectedDay.id].run) n[selectedDay.id].run={};
                                            n[selectedDay.id].run.bpm = e.target.value; setLogs(n);
                                        }}
                                    />
                                </div>
                                <div>
                                    <label className="text-xs opacity-60 flex justify-between">RPE (1-10) <span>{logs[selectedDay.id]?.run?.rpe || 5}</span></label>
                                    <input 
                                        type="range" min="1" max="10" className="w-full" 
                                        value={logs[selectedDay.id]?.run?.rpe || 5}
                                        onChange={(e) => {
                                            const n = {...logs}; if(!n[selectedDay.id]) n[selectedDay.id]={run:{}}; if(!n[selectedDay.id].run) n[selectedDay.id].run={};
                                            n[selectedDay.id].run.rpe = e.target.value; setLogs(n);
                                        }}
                                    />
                                </div>
                                {(selectedDay.subtype === 'easy' || selectedDay.type === 'bike') && (
                                    <button 
                                        onClick={() => toggleBike(selectedDay.id)}
                                        className="w-full p-2 border border-teal-500 text-teal-600 rounded text-xs font-bold"
                                    >
                                        üö¥ {configs[week].bike.includes(selectedDay.id) ? 'Zu Laufen wechseln' : 'Zu Rad wechseln'}
                                    </button>
                                )}
                            </div>
                        )}

                        {selectedDay.type === 'rest' && <p className="opacity-60 text-sm">Erhol dich gut!</p>}
                    </div>
                    <div className={`p-4 border-t ${darkMode ? 'border-slate-800 bg-slate-900' : 'border-slate-100 bg-slate-50'}`}>
                        <button 
                            onClick={() => { const n = {...logs}; if(!n[selectedDay.id]) n[selectedDay.id] = {}; n[selectedDay.id].done = true; setLogs(n); setSelectedDay(null); }}
                            className={`w-full py-3 rounded-xl font-bold flex justify-center gap-2 ${darkMode ? 'bg-blue-600 text-white' : 'bg-slate-900 text-white'}`}
                        >
                            <Save size={18} /> Speichern & Fertig
                        </button>
                    </div>
                </div>
            </div>
        )}

      </div>
    </div>
  );
}
